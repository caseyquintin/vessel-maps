<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vessel Location</title>
    
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .map-label {
            background-color: #ffffff;
            border-radius: 4px;
            padding: 4px 8px;
            font-family: Arial, sans-serif;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            white-space: nowrap;
        }
        
        .vessel-label { border: 2px solid #0078d4; color: #0078d4; }
        .origin-label { border: 2px solid #27ae60; color: #27ae60; }
        .destination-label { border: 2px solid #e67e22; color: #e67e22; }
        
        .map-marker {
            width: 18px;
            height: 18px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }
        
        .vessel-marker { background-color: #0078d4; }
        .origin-marker { background-color: #27ae60; }
        .destination-marker { background-color: #e67e22; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiY3F1ZWVuczIwMjUiLCJhIjoiY21pOWZzN2ZuMG9hYjJtb3BtNTVpdTM5ZiJ9.AhEHr3C1lTbme_znQswe9w';
        
        // =====================================================
        // GET PARAMETERS FROM URL
        // =====================================================
        
        const params = new URLSearchParams(window.location.search);
        
        const vesselLatRaw = params.get('lat');
        const vesselLngRaw = params.get('lng');
        const hasVesselCoords = vesselLatRaw && vesselLngRaw && vesselLatRaw !== '' && vesselLngRaw !== '';
        
        const vesselLat = parseFloat(vesselLatRaw) || null;
        const vesselLng = parseFloat(vesselLngRaw) || null;
        const vesselName = params.get('vessel') || 'Vessel';
        
        const originLat = parseFloat(params.get('originLat')) || null;
        const originLng = parseFloat(params.get('originLng')) || null;
        const originName = params.get('origin') || 'Origin';
        
        const destLat = parseFloat(params.get('destLat')) || null;
        const destLng = parseFloat(params.get('destLng')) || null;
        const destName = params.get('dest') || 'Destination';
        
        const displayType = params.get('display') || 'AllThreePoints';
        
        // =====================================================
        // DETERMINE WHICH POINTS TO SHOW
        // =====================================================
        
        const showVessel = hasVesselCoords;
        const showOrigin = (displayType === 'AllThreePoints' || displayType === 'VesselAndOrigin') && originLat && originLng;
        const showDest = (displayType === 'AllThreePoints' || displayType === 'VesselAndDestination') && destLat && destLng;
        
        const points = [];
        if (showVessel) points.push({lng: vesselLng, lat: vesselLat, type: 'vessel'});
        if (showOrigin) points.push({lng: originLng, lat: originLat, type: 'origin'});
        if (showDest) points.push({lng: destLng, lat: destLat, type: 'dest'});
        
        // =====================================================
        // ROUTE DETECTION
        // =====================================================
        
        function isInAtlanticIndianRegion(lng) {
            // Atlantic, Indian Ocean, Africa, Europe, Middle East: -30° to 90°
            return lng >= -30 && lng <= 90;
        }
        
        function isTransPacificRoute() {
            const hasAsiaPoint = points.some(p => p.lng >= 90 && p.lng <= 150);
            const hasAmericasPoint = points.some(p => p.lng >= -140 && p.lng <= -30);
            return hasAsiaPoint && hasAmericasPoint;
        }
        
        function detectRouteType() {
            if (!isTransPacificRoute()) {
                return 'Atlantic';
            }
            
            // For trans-Pacific routes, check if vessel is in Atlantic/Indian region
            if (showVessel && vesselLng !== null) {
                if (isInAtlanticIndianRegion(vesselLng)) {
                    return 'Atlantic'; // Suez route
                }
            }
            
            return 'Pacific'; // Default for trans-Pacific
        }
        
        const routeType = detectRouteType();
        
        // =====================================================
        // CALCULATE VIEW FOR PACIFIC ROUTES
        // For Pacific routes, we need to shift coordinates
        // to prevent fitBounds from going "the wrong way"
        // =====================================================
        
        function shiftLngForPacific(lng) {
            // Shift Americas coordinates to be > 180
            // So -120 becomes 240, keeping everything on same "side"
            return lng < 0 ? lng + 360 : lng;
        }
        
        function getViewParameters() {
            if (points.length === 0) {
                return { center: [0, 20], zoom: 2 };
            }
            
            if (points.length === 1) {
                return { center: [points[0].lng, points[0].lat], zoom: 5 };
            }
            
            if (routeType === 'Pacific') {
                // Shift all points to Pacific-centered coordinates
                const shifted = points.map(p => ({
                    lng: shiftLngForPacific(p.lng),
                    lat: p.lat
                }));
                
                // Calculate bounds in shifted space
                const lngs = shifted.map(p => p.lng);
                const lats = shifted.map(p => p.lat);
                
                const minLng = Math.min(...lngs);
                const maxLng = Math.max(...lngs);
                const minLat = Math.min(...lats);
                const maxLat = Math.max(...lats);
                
                // Calculate center in shifted space
                const centerLng = (minLng + maxLng) / 2;
                const centerLat = (minLat + maxLat) / 2;
                
                // Convert center back to -180/180 range
                const finalCenterLng = centerLng > 180 ? centerLng - 360 : centerLng;
                
                // Calculate appropriate zoom based on span
                const lngSpan = maxLng - minLng;
                const latSpan = maxLat - minLat;
                const maxSpan = Math.max(lngSpan, latSpan);
                
                // Rough zoom calculation (larger span = lower zoom)
                let zoom = 1;
                if (maxSpan < 30) zoom = 4;
                else if (maxSpan < 60) zoom = 3;
                else if (maxSpan < 120) zoom = 2;
                else zoom = 1;
                
                return { center: [finalCenterLng, centerLat], zoom: zoom };
            } else {
                // Atlantic route - use standard bounds
                const lngs = points.map(p => p.lng);
                const lats = points.map(p => p.lat);
                
                const centerLng = (Math.min(...lngs) + Math.max(...lngs)) / 2;
                const centerLat = (Math.min(...lats) + Math.max(...lats)) / 2;
                
                const lngSpan = Math.max(...lngs) - Math.min(...lngs);
                const latSpan = Math.max(...lats) - Math.min(...lats);
                const maxSpan = Math.max(lngSpan, latSpan);
                
                let zoom = 1;
                if (maxSpan < 30) zoom = 4;
                else if (maxSpan < 60) zoom = 3;
                else if (maxSpan < 120) zoom = 2;
                else zoom = 1;
                
                return { center: [centerLng, centerLat], zoom: zoom };
            }
        }
        
        const viewParams = getViewParameters();
        
        // =====================================================
        // CREATE THE MAP
        // =====================================================
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: viewParams.center,
            zoom: viewParams.zoom,
            projection: 'mercator'
        });
        
        map.addControl(new mapboxgl.NavigationControl());
        
        // =====================================================
        // ADD MARKERS
        // =====================================================
        
        function addMarker(lng, lat, name, markerClass, labelClass) {
            const markerEl = document.createElement('div');
            markerEl.className = 'map-marker ' + markerClass;
            
            const labelEl = document.createElement('div');
            labelEl.className = 'map-label ' + labelClass;
            labelEl.textContent = name;
            
            new mapboxgl.Marker(markerEl)
                .setLngLat([lng, lat])
                .addTo(map);
            
            new mapboxgl.Marker(labelEl, { offset: [0, -25] })
                .setLngLat([lng, lat])
                .addTo(map);
        }
        
        if (showVessel) {
            addMarker(vesselLng, vesselLat, vesselName, 'vessel-marker', 'vessel-label');
        }
        
        if (showOrigin) {
            addMarker(originLng, originLat, originName, 'origin-marker', 'origin-label');
        }
        
        if (showDest) {
            addMarker(destLng, destLat, destName, 'destination-marker', 'destination-label');
        }
        
        document.title = vesselName + ' - Vessel Tracking';
    </script>
</body>
</html>
