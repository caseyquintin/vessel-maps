<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vessel Location</title>
    
    <!-- MapBox GL JS library -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
    
    <style>
        /* Make map fill the entire browser window */
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* Style for labels */
        .map-label {
            background-color: #ffffff;
            border-radius: 4px;
            padding: 4px 8px;
            font-family: Arial, sans-serif;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            white-space: nowrap;
        }
        
        /* Vessel label - blue border */
        .vessel-label {
            border: 2px solid #0078d4;
            color: #0078d4;
        }
        
        /* Origin label - green border */
        .origin-label {
            border: 2px solid #27ae60;
            color: #27ae60;
        }
        
        /* Destination label - orange border */
        .destination-label {
            border: 2px solid #e67e22;
            color: #e67e22;
        }
        
        /* Marker dots */
        .map-marker {
            width: 18px;
            height: 18px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }
        
        /* Vessel marker - blue */
        .vessel-marker { background-color: #0078d4; }
        
        /* Origin marker - green */
        .origin-marker { background-color: #27ae60; }
        
        /* Destination marker - orange */
        .destination-marker { background-color: #e67e22; }
    </style>
</head>
<body>
    <!-- Map container -->
    <div id="map"></div>
    
    <script>
        // =====================================================
        // CONFIGURATION
        // =====================================================
        
        mapboxgl.accessToken = 'pk.eyJ1IjoiY3F1ZWVuczIwMjUiLCJhIjoiY21pOWZzN2ZuMG9hYjJtb3BtNTVpdTM5ZiJ9.AhEHr3C1lTbme_znQswe9w';
        
        // =====================================================
        // GET PARAMETERS FROM URL
        // =====================================================
        
        const params = new URLSearchParams(window.location.search);
        
        // Vessel coordinates (required)
        const vesselLat = parseFloat(params.get('lat')) || 0;
        const vesselLng = parseFloat(params.get('lng')) || 0;
        const vesselName = params.get('vessel') || 'Vessel';
        
        // Origin coordinates (optional)
        const originLat = parseFloat(params.get('originLat')) || null;
        const originLng = parseFloat(params.get('originLng')) || null;
        const originName = params.get('origin') || 'Origin';
        
        // Destination coordinates (optional)
        const destLat = parseFloat(params.get('destLat')) || null;
        const destLng = parseFloat(params.get('destLng')) || null;
        const destName = params.get('dest') || 'Destination';
        
        // Display type: AllThreePoints, VesselAndDestination, VesselAndOrigin
        const displayType = params.get('display') || 'AllThreePoints';
        
        // =====================================================
        // DETERMINE WHICH POINTS TO SHOW
        // =====================================================
        
        const showVessel = true; // Always show vessel
        const showOrigin = (displayType === 'AllThreePoints' || displayType === 'VesselAndOrigin') && originLat && originLng;
        const showDest = (displayType === 'AllThreePoints' || displayType === 'VesselAndDestination') && destLat && destLng;
        
        // =====================================================
        // COLLECT ALL VISIBLE POINTS
        // =====================================================
        
        const points = [{lng: vesselLng, lat: vesselLat}];
        if (showOrigin) points.push({lng: originLng, lat: originLat});
        if (showDest) points.push({lng: destLng, lat: destLat});
        
        // =====================================================
        // DETECT IF ROUTE CROSSES THE PACIFIC
        // (Points in both East Asia and Americas)
        // =====================================================
        
        function isPacificRoute(points) {
            // Check if we have points on both sides of the Pacific
            const hasAsiaPoint = points.some(p => p.lng > 90 || p.lng < -150);
            const hasAmericasPoint = points.some(p => p.lng > -140 && p.lng < -30);
            return hasAsiaPoint && hasAmericasPoint;
        }
        
        // Adjust longitude for Pacific-centered view
        // Shifts coordinates so Pacific Ocean is in the center
        function adjustLngForPacific(lng) {
            // Shift negative longitudes (Americas) to positive values
            // So -120 (California) becomes 240, placing it "east" of Asia
            return lng < 0 ? lng + 360 : lng;
        }
        
        // =====================================================
        // CALCULATE MAP CENTER AND BOUNDS
        // =====================================================
        
        let mapCenter;
        let mapBounds;
        const crossesPacific = isPacificRoute(points);
        
        if (crossesPacific && points.length > 1) {
            // For Pacific routes, calculate center using adjusted coordinates
            const adjustedPoints = points.map(p => ({
                lng: adjustLngForPacific(p.lng),
                lat: p.lat
            }));
            
            // Calculate average center
            const avgLng = adjustedPoints.reduce((sum, p) => sum + p.lng, 0) / adjustedPoints.length;
            const avgLat = adjustedPoints.reduce((sum, p) => sum + p.lat, 0) / adjustedPoints.length;
            
            // Convert back to standard longitude (-180 to 180)
            const centerLng = avgLng > 180 ? avgLng - 360 : avgLng;
            mapCenter = [centerLng, avgLat];
            
            // Calculate bounds with adjusted coordinates
            const lngs = adjustedPoints.map(p => p.lng);
            const lats = points.map(p => p.lat);
            
            const minLng = Math.min(...lngs);
            const maxLng = Math.max(...lngs);
            const minLat = Math.min(...lats);
            const maxLat = Math.max(...lats);
            
            // Convert bounds back to standard coordinates
            mapBounds = [
                [minLng > 180 ? minLng - 360 : minLng, minLat],
                [maxLng > 180 ? maxLng - 360 : maxLng, maxLat]
            ];
        } else {
            // Standard bounds calculation for non-Pacific routes
            mapCenter = [vesselLng, vesselLat];
            mapBounds = new mapboxgl.LngLatBounds();
            points.forEach(p => mapBounds.extend([p.lng, p.lat]));
        }
        
        // =====================================================
        // CREATE THE MAP (FLAT PROJECTION, PACIFIC-CENTERED)
        // =====================================================
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: mapCenter,
            zoom: 3,
            projection: 'mercator'
        });
        
        // Fit map to show all points with padding
        if (points.length > 1) {
            if (crossesPacific) {
                // For Pacific routes, use calculated center and zoom
                map.setCenter(mapCenter);
                map.setZoom(2); // Start zoomed out, then fit
                
                // Use fitBounds but allow it to cross the antimeridian
                const bounds = new mapboxgl.LngLatBounds();
                points.forEach(p => bounds.extend([p.lng, p.lat]));
                
                // Fit with extra padding and let MapBox handle it
                map.fitBounds(bounds, { 
                    padding: 80, 
                    maxZoom: 8,
                    // This tells MapBox to consider the shorter Pacific route
                    center: mapCenter
                });
            } else {
                map.fitBounds(mapBounds, { padding: 80, maxZoom: 10 });
            }
        }
        
        // Add zoom controls
        map.addControl(new mapboxgl.NavigationControl());
        
        // =====================================================
        // HELPER FUNCTION TO ADD MARKERS
        // =====================================================
        
        function addMarker(lng, lat, name, markerClass, labelClass) {
            // Create marker dot
            const markerEl = document.createElement('div');
            markerEl.className = 'map-marker ' + markerClass;
            
            // Create label
            const labelEl = document.createElement('div');
            labelEl.className = 'map-label ' + labelClass;
            labelEl.textContent = name;
            
            // Add marker to map
            new mapboxgl.Marker(markerEl)
                .setLngLat([lng, lat])
                .addTo(map);
            
            // Add label above marker
            new mapboxgl.Marker(labelEl, { offset: [0, -25] })
                .setLngLat([lng, lat])
                .addTo(map);
        }
        
        // =====================================================
        // ADD MARKERS BASED ON DISPLAY TYPE
        // =====================================================
        
        // Always add vessel marker
        addMarker(vesselLng, vesselLat, vesselName, 'vessel-marker', 'vessel-label');
        
        // Add origin if applicable
        if (showOrigin) {
            addMarker(originLng, originLat, originName, 'origin-marker', 'origin-label');
        }
        
        // Add destination if applicable
        if (showDest) {
            addMarker(destLng, destLat, destName, 'destination-marker', 'destination-label');
        }
        
        // Update page title
        document.title = vesselName + ' - Vessel Tracking';
    </script>
</body>
</html>

