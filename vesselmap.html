<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vessel Location</title>
    
    <!-- MapBox GL JS library -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .map-label {
            background-color: #ffffff;
            border-radius: 4px;
            padding: 4px 8px;
            font-family: Arial, sans-serif;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            white-space: nowrap;
        }
        
        .vessel-label {
            border: 2px solid #0078d4;
            color: #0078d4;
        }
        
        .origin-label {
            border: 2px solid #27ae60;
            color: #27ae60;
        }
        
        .destination-label {
            border: 2px solid #e67e22;
            color: #e67e22;
        }
        
        .map-marker {
            width: 18px;
            height: 18px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }
        
        .vessel-marker { background-color: #0078d4; }
        .origin-marker { background-color: #27ae60; }
        .destination-marker { background-color: #e67e22; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <script>
        // =====================================================
        // CONFIGURATION
        // =====================================================
        
        mapboxgl.accessToken = 'pk.eyJ1IjoiY3F1ZWVuczIwMjUiLCJhIjoiY21pOWZzN2ZuMG9hYjJtb3BtNTVpdTM5ZiJ9.AhEHr3C1lTbme_znQswe9w';
        
        // =====================================================
        // GET PARAMETERS FROM URL
        // =====================================================
        
        const params = new URLSearchParams(window.location.search);
        
        // Vessel coordinates
        const vesselLatRaw = params.get('lat');
        const vesselLngRaw = params.get('lng');
        const hasVesselCoords = vesselLatRaw && vesselLngRaw && vesselLatRaw !== '' && vesselLngRaw !== '';
        
        const vesselLat = parseFloat(vesselLatRaw) || null;
        const vesselLng = parseFloat(vesselLngRaw) || null;
        const vesselName = params.get('vessel') || 'Vessel';
        
        // Origin coordinates
        const originLat = parseFloat(params.get('originLat')) || null;
        const originLng = parseFloat(params.get('originLng')) || null;
        const originName = params.get('origin') || 'Origin';
        
        // Destination coordinates
        const destLat = parseFloat(params.get('destLat')) || null;
        const destLng = parseFloat(params.get('destLng')) || null;
        const destName = params.get('dest') || 'Destination';
        
        // Display type
        const displayType = params.get('display') || 'AllThreePoints';
        
        // =====================================================
        // DETERMINE WHICH POINTS TO SHOW
        // =====================================================
        
        const showVessel = hasVesselCoords;
        const showOrigin = (displayType === 'AllThreePoints' || displayType === 'VesselAndOrigin') && originLat && originLng;
        const showDest = (displayType === 'AllThreePoints' || displayType === 'VesselAndDestination') && destLat && destLng;
        
        // =====================================================
        // COLLECT ALL VISIBLE POINTS
        // =====================================================
        
        const points = [];
        if (showVessel) points.push({lng: vesselLng, lat: vesselLat, type: 'vessel'});
        if (showOrigin) points.push({lng: originLng, lat: originLat, type: 'origin'});
        if (showDest) points.push({lng: destLng, lat: destLat, type: 'dest'});
        
        // =====================================================
        // SMART ROUTE DETECTION - VESSEL POSITION FIRST
        // =====================================================
        
        function isInPacificRegion(lng) {
            // Pacific region: East Asia (90° to 180°) OR Eastern Pacific (-180° to -100°)
            // This covers: Asia, Pacific Ocean, US West Coast area
            return lng >= 90 || lng <= -100;
        }
        
        function isInAtlanticRegion(lng) {
            // Atlantic/Indian Ocean region: -30° to 90°
            // This covers: Atlantic, Indian Ocean, Africa, Europe, Middle East
            return lng > -30 && lng < 90;
        }
        
        function isTransPacificRoute() {
            // Check if we have points on both sides of the Pacific
            const hasAsiaPoint = points.some(p => p.lng >= 90 && p.lng <= 145);
            const hasAmericasPoint = points.some(p => p.lng >= -130 && p.lng <= -30);
            return hasAsiaPoint && hasAmericasPoint;
        }
        
        function detectRouteType() {
            // First check: Is this even a trans-oceanic route?
            if (!isTransPacificRoute()) {
                return 'Atlantic'; // Default view for regional routes
            }
            
            // PRIORITY: Use vessel position to determine route
            // This is the most reliable indicator of which way the ship is going
            if (showVessel && vesselLng !== null) {
                // Vessel in Atlantic/Indian Ocean = Suez route
                if (isInAtlanticRegion(vesselLng)) {
                    return 'Atlantic';
                }
                // Vessel in Pacific region = Pacific route (West Coast OR Panama)
                if (isInPacificRegion(vesselLng)) {
                    return 'Pacific';
                }
            }
            
            // Fallback: Default to Pacific for Asia-Americas routes
            return 'Pacific';
        }
        
        const routeType = detectRouteType();
        
        // =====================================================
        // CALCULATE MAP CENTER BASED ON ROUTE TYPE
        // =====================================================
        
        function getMapCenter() {
            if (points.length === 0) {
                return [0, 20];
            }
            
            if (routeType === 'Pacific') {
                // Shift longitudes so Pacific is centered
                const adjustedPoints = points.map(p => ({
                    lng: p.lng < 0 ? p.lng + 360 : p.lng,
                    lat: p.lat
                }));
                
                const avgLng = adjustedPoints.reduce((sum, p) => sum + p.lng, 0) / adjustedPoints.length;
                const avgLat = adjustedPoints.reduce((sum, p) => sum + p.lat, 0) / adjustedPoints.length;
                
                const centerLng = avgLng > 180 ? avgLng - 360 : avgLng;
                return [centerLng, avgLat];
            } else {
                const avgLng = points.reduce((sum, p) => sum + p.lng, 0) / points.length;
                const avgLat = points.reduce((sum, p) => sum + p.lat, 0) / points.length;
                return [avgLng, avgLat];
            }
        }
        
        const mapCenter = getMapCenter();
        
        // =====================================================
        // CREATE THE MAP
        // =====================================================
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: mapCenter,
            zoom: 2,
            projection: 'mercator'
        });
        
        // Fit map to show all points
        if (points.length > 1) {
            const bounds = new mapboxgl.LngLatBounds();
            points.forEach(p => bounds.extend([p.lng, p.lat]));
            
            map.fitBounds(bounds, { 
                padding: {top: 100, bottom: 100, left: 150, right: 150},
                maxZoom: 6
            });
        } else if (points.length === 1) {
            map.setCenter([points[0].lng, points[0].lat]);
            map.setZoom(5);
        }
        
        map.addControl(new mapboxgl.NavigationControl());
        
        // =====================================================
        // ADD MARKERS
        // =====================================================
        
        function addMarker(lng, lat, name, markerClass, labelClass) {
            const markerEl = document.createElement('div');
            markerEl.className = 'map-marker ' + markerClass;
            
            const labelEl = document.createElement('div');
            labelEl.className = 'map-label ' + labelClass;
            labelEl.textContent = name;
            
            new mapboxgl.Marker(markerEl)
                .setLngLat([lng, lat])
                .addTo(map);
            
            new mapboxgl.Marker(labelEl, { offset: [0, -25] })
                .setLngLat([lng, lat])
                .addTo(map);
        }
        
        if (showVessel) {
            addMarker(vesselLng, vesselLat, vesselName, 'vessel-marker', 'vessel-label');
        }
        
        if (showOrigin) {
            addMarker(originLng, originLat, originName, 'origin-marker', 'origin-label');
        }
        
        if (showDest) {
            addMarker(destLng, destLat, destName, 'destination-marker', 'destination-label');
        }
        
        document.title = vesselName + ' - Vessel Tracking';
    </script>
</body>
</html>
