<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vessel Location</title>
    
    <!-- MapBox GL JS library -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
    
    <style>
        /* Make map fill the entire browser window */
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* Style for labels */
        .map-label {
            background-color: #ffffff;
            border-radius: 4px;
            padding: 4px 8px;
            font-family: Arial, sans-serif;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            white-space: nowrap;
        }
        
        /* Vessel label - blue border */
        .vessel-label {
            border: 2px solid #0078d4;
            color: #0078d4;
        }
        
        /* Origin label - green border */
        .origin-label {
            border: 2px solid #27ae60;
            color: #27ae60;
        }
        
        /* Destination label - orange border */
        .destination-label {
            border: 2px solid #e67e22;
            color: #e67e22;
        }
        
        /* Marker dots */
        .map-marker {
            width: 18px;
            height: 18px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }
        
        /* Vessel marker - blue */
        .vessel-marker { background-color: #0078d4; }
        
        /* Origin marker - green */
        .origin-marker { background-color: #27ae60; }
        
        /* Destination marker - orange */
        .destination-marker { background-color: #e67e22; }
    </style>
</head>
<body>
    <!-- Map container -->
    <div id="map"></div>
    
    <script>
        // =====================================================
        // CONFIGURATION
        // =====================================================
        
        mapboxgl.accessToken = 'pk.eyJ1IjoiY3F1ZWVuczIwMjUiLCJhIjoiY21pOWZzN2ZuMG9hYjJtb3BtNTVpdTM5ZiJ9.AhEHr3C1lTbme_znQswe9w';
        
        // =====================================================
        // GET PARAMETERS FROM URL
        // =====================================================
        
        const params = new URLSearchParams(window.location.search);
        
        // Vessel coordinates - check if they're actually provided
        const vesselLatRaw = params.get('lat');
        const vesselLngRaw = params.get('lng');
        const hasVesselCoords = vesselLatRaw && vesselLngRaw && vesselLatRaw !== '' && vesselLngRaw !== '';
        
        const vesselLat = parseFloat(vesselLatRaw) || null;
        const vesselLng = parseFloat(vesselLngRaw) || null;
        const vesselName = params.get('vessel') || 'Vessel';
        
        // Origin coordinates (optional)
        const originLatRaw = params.get('originLat');
        const originLngRaw = params.get('originLng');
        const originLat = parseFloat(originLatRaw) || null;
        const originLng = parseFloat(originLngRaw) || null;
        const originName = params.get('origin') || 'Origin';
        
        // Destination coordinates (optional)
        const destLatRaw = params.get('destLat');
        const destLngRaw = params.get('destLng');
        const destLat = parseFloat(destLatRaw) || null;
        const destLng = parseFloat(destLngRaw) || null;
        const destName = params.get('dest') || 'Destination';
        
        // Display type: AllThreePoints, VesselAndDestination, VesselAndOrigin
        const displayType = params.get('display') || 'AllThreePoints';
        
        // =====================================================
        // DETERMINE WHICH POINTS TO SHOW
        // =====================================================
        
        const showVessel = hasVesselCoords;
        const showOrigin = (displayType === 'AllThreePoints' || displayType === 'VesselAndOrigin') && originLat && originLng;
        const showDest = (displayType === 'AllThreePoints' || displayType === 'VesselAndDestination') && destLat && destLng;
        
        // =====================================================
        // COLLECT ALL VISIBLE POINTS
        // =====================================================
        
        const points = [];
        if (showVessel) points.push({lng: vesselLng, lat: vesselLat, type: 'vessel'});
        if (showOrigin) points.push({lng: originLng, lat: originLat, type: 'origin'});
        if (showDest) points.push({lng: destLng, lat: destLat, type: 'dest'});
        
        // =====================================================
        // SMART ROUTE DETECTION
        // =====================================================
        
        function isInAsia(lng) {
            // East Asia, Southeast Asia: roughly 90°E to 145°E
            return lng >= 90 && lng <= 145;
        }
        
        function isInAmericas(lng) {
            // Americas: roughly -130°W to -30°W
            return lng >= -130 && lng <= -30;
        }
        
        function isInAtlanticRegion(lng) {
            // Atlantic, Indian Ocean, Africa, Europe, Middle East: -30°W to 90°E
            // This is where a vessel would be if taking the Suez/Africa route
            return lng >= -30 && lng <= 90;
        }
        
        function detectRouteType() {
            // Check if this is an Asia ↔ Americas route
            const hasAsiaPoint = points.some(p => isInAsia(p.lng));
            const hasAmericasPoint = points.some(p => isInAmericas(p.lng));
            
            // If not an Asia-Americas route, use default Atlantic-centered view
            if (!hasAsiaPoint || !hasAmericasPoint) {
                return 'Atlantic';
            }
            
            // This IS an Asia-Americas route
            // Check if vessel position tells us which way it's going
            if (showVessel && vesselLng !== null) {
                // If vessel is in Atlantic/Indian Ocean/Africa region → Atlantic route
                if (isInAtlanticRegion(vesselLng)) {
                    return 'Atlantic';
                }
            }
            
            // Default: Pacific route for Asia-Americas
            // (Most common, and works when vessel position is unknown)
            return 'Pacific';
        }
        
        const routeType = detectRouteType();
        
        // =====================================================
        // CALCULATE MAP CENTER BASED ON ROUTE TYPE
        // =====================================================
        
        function getMapCenter() {
            if (points.length === 0) {
                return [0, 20]; // Default center
            }
            
            if (routeType === 'Pacific') {
                // Shift longitudes so Pacific is centered
                // Convert negative (Americas) longitudes to >180
                const adjustedPoints = points.map(p => ({
                    lng: p.lng < 0 ? p.lng + 360 : p.lng,
                    lat: p.lat
                }));
                
                const avgLng = adjustedPoints.reduce((sum, p) => sum + p.lng, 0) / adjustedPoints.length;
                const avgLat = adjustedPoints.reduce((sum, p) => sum + p.lat, 0) / adjustedPoints.length;
                
                // Convert back to standard -180 to 180 range
                const centerLng = avgLng > 180 ? avgLng - 360 : avgLng;
                return [centerLng, avgLat];
            } else {
                // Standard Atlantic-centered average
                const avgLng = points.reduce((sum, p) => sum + p.lng, 0) / points.length;
                const avgLat = points.reduce((sum, p) => sum + p.lat, 0) / points.length;
                return [avgLng, avgLat];
            }
        }
        
        const mapCenter = getMapCenter();
        
        // =====================================================
        // CREATE THE MAP
        // =====================================================
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: mapCenter,
            zoom: 3,
            projection: 'mercator'
        });
        
        // Fit map to show all points
        if (points.length > 1) {
            const bounds = new mapboxgl.LngLatBounds();
            points.forEach(p => bounds.extend([p.lng, p.lat]));
            
            map.fitBounds(bounds, { 
                padding: 100, 
                maxZoom: 8
            });
        } else if (points.length === 1) {
            map.setCenter([points[0].lng, points[0].lat]);
            map.setZoom(6);
        }
        
        // Add zoom controls
        map.addControl(new mapboxgl.NavigationControl());
        
        // =====================================================
        // HELPER FUNCTION TO ADD MARKERS
        // =====================================================
        
        function addMarker(lng, lat, name, markerClass, labelClass) {
            // Create marker dot
            const markerEl = document.createElement('div');
            markerEl.className = 'map-marker ' + markerClass;
            
            // Create label
            const labelEl = document.createElement('div');
            labelEl.className = 'map-label ' + labelClass;
            labelEl.textContent = name;
            
            // Add marker to map
            new mapboxgl.Marker(markerEl)
                .setLngLat([lng, lat])
                .addTo(map);
            
            // Add label above marker
            new mapboxgl.Marker(labelEl, { offset: [0, -25] })
                .setLngLat([lng, lat])
                .addTo(map);
        }
        
        // =====================================================
        // ADD MARKERS
        // =====================================================
        
        if (showVessel) {
            addMarker(vesselLng, vesselLat, vesselName, 'vessel-marker', 'vessel-label');
        }
        
        if (showOrigin) {
            addMarker(originLng, originLat, originName, 'origin-marker', 'origin-label');
        }
        
        if (showDest) {
            addMarker(destLng, destLat, destName, 'destination-marker', 'destination-label');
        }
        
        // Update page title
        document.title = vesselName + ' - Vessel Tracking';
    </script>
</body>
</html>
